<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.vietnam.lottery.business.unpackRedPackets.mapper.UnpackRedPacketsMapper">

    <select id="drawProbability" resultType="com.vietnam.lottery.business.basicIndicators.response.ProbabilityResponse">
        select
        a.probability,
        a.`name`,
        sum( b.amount ) AS amount
        from unpack_red_packets a
        inner join lottery_detail b on a.id = b.unpack_red_packets_id
        where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(a.create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(a.create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        group by a.`name`
    </select>

    <select id="statistics" resultType="com.vietnam.lottery.business.basicIndicators.response.IndicatorsResponse">
        select
        (select COUNT(*) from sys_login_detail
        where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        ) as visitorsTotalNumber,
        (
        SELECT count( 0 ) FROM (SELECT count( 0 ) AS newVisitors FROM sys_login_detail
        where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        GROUP BY ip HAVING newVisitors = 1) c
        ) newVisitors,
        (
        select COUNT(*) from sys_login_detail where temporary_user = '2'
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        )as totalLogins,
        (
        SELECT COUNT(*) FROM sys_user where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        )as newRegistration,
        (
        SELECT COUNT(*)FROM grab_red_packets
        where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        )as envelopesNumber,
        (
        SELECT IFNULL(SUM(amount),0) FROM grab_red_packets
        where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        )as envelopesTotalAmount,
        (
        SELECT COUNT(*) FROM unpack_red_packets
        where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        )as envelopesRemoveNumber,
        (
        SELECT IFNULL(SUM(amount),0) FROM lottery_detail
        where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        )as totalPrize,
        (
        SELECT IFNULL(SUM(amount),0) FROM recharge_detail
        where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        )as totalRecharge,
        (
        SELECT IFNULL(SUM(amount),0) FROM withdraw_detail
        where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        )as totalWithdrawal
    </select>
</mapper>

