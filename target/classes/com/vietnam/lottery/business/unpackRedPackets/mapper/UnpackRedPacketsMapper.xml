<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.vietnam.lottery.business.unpackRedPackets.mapper.UnpackRedPacketsMapper">

    <select id="drawProbability" resultType="com.vietnam.lottery.business.basicIndicators.response.ProbabilityResponse">
        select
        a.probability,
        a.`name`,
        sum( b.amount ) AS amount
        from unpack_red_packets a
        inner join lottery_detail b on a.id = b.unpack_red_packets_id
        where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(a.create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(a.create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        group by a.`name`
    </select>

    <select id="statistics" resultType="com.vietnam.lottery.business.basicIndicators.response.IndicatorsResponse">
        select
        (select COUNT(*) from sys_login_detail
        where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        ) as visitorsTotalNumber,
        (
        SELECT count( 0 ) FROM (SELECT count( 0 ) AS newVisitors FROM sys_login_detail
        where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        GROUP BY ip HAVING newVisitors = 1) c
        ) newVisitors,
        (
        select COUNT(*) from sys_login_detail where temporary_user = '2'
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        )as totalLogins,
        (
        SELECT COUNT(*) FROM sys_user where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        )as newRegistration,
        (
        SELECT COUNT(*)FROM grab_red_packets
        where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        )as envelopesNumber,
        (
        SELECT IFNULL(SUM(amount),0) FROM grab_red_packets
        where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        )as envelopesTotalAmount,
        (
        SELECT COUNT(*) FROM unpack_red_packets
        where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        )as envelopesRemoveNumber,
        (
        SELECT IFNULL(SUM(amount),0) FROM lottery_detail
        where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        )as totalPrize,
        (
        SELECT IFNULL(SUM(amount),0) FROM recharge_detail
        where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        )as totalRecharge,
        (
        SELECT IFNULL(SUM(amount),0) FROM withdraw_detail
        where 1=1
        <if test="request.beginDate != null and request.beginDate != ''">
            and date_format(create_date,'%Y-%m-%d') &gt;= date_format(#{request.beginDate},'%Y-%m-%d')
        </if>
        <if test="request.endDate != null and request.endDate != ''">
            and date_format(create_date,'%Y-%m-%d') &lt;= date_format(#{request.endDate},'%Y-%m-%d')
        </if>
        )as totalWithdrawal
    </select>

    <select id="keep" resultType="com.vietnam.lottery.business.basicIndicators.response.KeepListResponse">
        select count(distinct b.create_by)                                                               as secondStay,
               count(distinct c.create_by)                                                               as three,
               count(distinct d.create_by)                                                               as sevenStay,
               count(distinct e.create_by)                                                               as fifteenStay,
               count(distinct f.create_by)                                                               as monthStay,
               count(distinct b.create_by) / (select count(0)
                                              from sys_user
                                              where create_date between
                                                        #{request.secondBegin} and #{request.secondEnd}) as secondPer,
               count(distinct c.create_by) / (select count(0)
                                              from sys_user
                                              where create_date between
                                                        #{request.treeBegin} and #{request.treeEnd})     as threePer,
               count(distinct d.create_by) / (select count(0)
                                              from sys_user
                                              where create_date between
                                                        #{request.serverBegin} and #{request.serverEnd}) as sevenStayPer,
               count(distinct e.create_by) / (select count(0)
                                              from sys_user
                                              where create_date between
                                                        #{request.fifteenBegin} and #{request.fifteenEnd}) as fifteenStayPer,
               count(distinct f.create_by) / (select count(0)
                                              from sys_user
                                              where create_date between
                                                        #{request.mothBegin} and #{request.mothEnd}) as monthStayPer
        from sys_login_detail a
                 left join
             (select create_by
              from sys_login_detail
              where datediff(#{request.beginDate}, #{request.second}) = 1
              group by create_by) b
             on a.create_by = b.create_by
                 left join
             (select create_by
              from sys_login_detail
              where datediff(#{request.beginDate}, #{request.tree}) = 3
              group by create_by) c on a.create_by = b.create_by
                 left join
             (select create_by
              from sys_login_detail
              where datediff(#{request.beginDate}, #{request.server}) = 7
              group by create_by) d on a.create_by = b.create_by
                 left join
             (select create_by
              from sys_login_detail
              where datediff(#{request.beginDate}, #{request.fifteen}) = 15
              group by create_by) e on a.create_by = b.create_by
                 left join (select create_by
                            from sys_login_detail
                            where datediff(#{request.beginDate}, #{request.moth}) = 30
                            group by create_by) f on a.create_by = b.create_by
    </select>
</mapper>

